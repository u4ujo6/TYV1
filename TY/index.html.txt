<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wei了你，算好了</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 自訂主題顏色 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // 下午 (航廈藍)
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
            },
            // 上午 (跑道橘/晨曦)
            morning: {
              50: '#fff7ed',
              100: '#ffedd5',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
            }
          },
          backgroundImage: {
            'clouds': "url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%239C92AC\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')",
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
    .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
    .theme-transition { transition: all 0.3s ease; }
    /* 隱藏時間輸入框的時鐘icon */
    input[type="time"]::-webkit-calendar-picker-indicator {
      background: transparent; bottom: 0; color: transparent; cursor: pointer;
      height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
    }
    /* 登機證虛線效果 */
    .boarding-dashed {
      background-image: linear-gradient(to right, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0) 0%);
      background-position: bottom;
      background-size: 10px 1px;
      background-repeat: repeat-x;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen text-slate-800 pb-10 bg-clouds">

  <!-- Header -->
  <header id="mainHeader" class="bg-morning-600 text-white p-4 shadow-lg sticky top-0 z-20 theme-transition">
    <div class="flex items-center justify-between max-w-md mx-auto">
      <div class="flex items-center space-x-3">
        <img src="logo.png"
             onerror="this.style.display='none'; document.getElementById('fallback-icon').style.display='block'"
             class="h-8 w-auto rounded bg-white/10 p-1" alt="Logo">
        <i id="fallback-icon" class="fa-solid fa-plane-up text-xl hidden"></i>
        <div class="flex flex-col leading-none">
          <h1 class="text-lg font-bold tracking-wide">Wei了你，算好了</h1>
        </div>
      </div>
      <span class="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/20">
        <i class="fa-solid fa-plane mr-1"></i>2026桃園機場專用版
      </span>
    </div>
  </header>

  <main class="max-w-md mx-auto p-4 space-y-4">

    <!-- 1. 模式切換 -->
    <div class="grid grid-cols-2 gap-3 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
      <!-- 左：上午 -->
      <button onclick="setMode('morning')" id="btnMorning"
        class="btn-press py-4 rounded-lg flex flex-col items-center justify-center border-2 border-transparent relative overflow-hidden theme-transition group">
        <div class="text-3xl mb-1 transform group-hover:translate-y-1 transition-transform"><i class="fa-solid fa-plane-arrival"></i></div>
        <div class="text-base font-bold">上午請假</div>
        <span class="text-xs opacity-70">晚到班 / Arrival</span>
      </button>

      <!-- 右：下午 -->
      <button onclick="setMode('leave')" id="btnLeave"
        class="btn-press py-4 rounded-lg flex flex-col items-center justify-center border-2 border-transparent relative overflow-hidden theme-transition group">
        <div class="text-3xl mb-1 transform group-hover:-translate-y-1 transition-transform"><i class="fa-solid fa-plane-departure"></i></div>
        <div class="text-base font-bold">下午請假</div>
        <span class="text-xs opacity-70">提早走 / Departure</span>
      </button>
    </div>

    <!-- 2. 上班時間 (僅下午模式) -->
    <section id="sectionTimeInput" class="bg-white rounded-2xl p-5 shadow-sm border border-slate-200 theme-transition hidden">
      <label class="block text-sm font-bold text-slate-500 mb-2">今天幾點上班 (刷卡時間)</label>
      <div class="relative group">
        <input type="time" id="arrivalTime"
          class="w-full text-3xl font-bold text-center bg-slate-50 border-2 border-slate-200 rounded-xl p-3 focus:outline-none focus:border-morning-500 theme-transition text-slate-700"
          value="08:32">
        <div class="absolute right-4 top-4 text-slate-400 pointer-events-none group-hover:text-brand-500 transition-colors">
          <i class="fa-regular fa-clock"></i>
        </div>
      </div>
      <div id="earlyWarning" class="hidden mt-2 text-xs font-bold bg-blue-50 text-blue-600 p-2 rounded-lg flex items-center">
        <i class="fa-solid fa-circle-check mr-2"></i> 早於 08:00，以 08:00 計算
      </div>
    </section>

    <!-- 3. 控制面板 -->
    <section class="bg-white rounded-2xl p-5 shadow-sm border border-slate-200">
      <div class="mb-4">
        <label class="block text-sm font-bold text-slate-500 mb-2">請假單位</label>
        <div class="relative">
          <select id="leaveType" onchange="updateStep()"
            class="w-full bg-slate-50 border border-slate-200 text-slate-700 font-bold rounded-lg p-3 appearance-none focus:outline-none focus:border-morning-500 theme-transition">
            <option value="0.5">特休 / 補休 (0.5 小時)</option>
            <option value="1">事假 / 病假 (1 小時)</option>
          </select>
          <div class="absolute right-4 top-3.5 text-slate-400 pointer-events-none">
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
      </div>

      <label class="block text-sm font-bold text-slate-500 mb-2">預計請假時數</label>
      <div class="flex items-center justify-between bg-slate-50 rounded-xl p-2 border border-slate-200">
        <button onclick="changeHours(-1)" id="btnMinus"
          class="btn-press w-14 h-14 rounded-lg bg-white shadow-sm border border-slate-200 text-2xl font-bold theme-transition hover:bg-slate-50 flex items-center justify-center text-morning-600">-</button>

        <div class="text-center flex-1">
          <span id="displayHours" class="text-4xl font-bold text-slate-800 tracking-tight">1.5</span>
          <span class="text-xs text-slate-400 block mt-1">小時</span>
        </div>

        <button onclick="changeHours(1)" id="btnPlus"
          class="btn-press w-14 h-14 rounded-lg bg-white shadow-sm border border-slate-200 text-2xl font-bold theme-transition hover:bg-slate-50 flex items-center justify-center text-morning-600">+</button>
      </div>
    </section>

    <!-- 4. 結果卡片 -->
    <section id="resultCard" class="rounded-2xl shadow-xl text-white relative overflow-hidden theme-transition bg-morning-600 transition-colors duration-300">
      <!-- 上半部 -->
      <div class="p-5 relative z-10">
        <div class="flex items-center justify-between mb-4 pb-2 boarding-dashed">
          <h3 class="text-sm font-bold tracking-wider flex items-center pb-2">
            <i class="fa-solid fa-ticket mr-2"></i>假單填寫看我
          </h3>
          <div id="statusTag" class="hidden mb-2 text-[10px] bg-yellow-300 text-yellow-900 px-2 py-1 rounded-full font-bold uppercase tracking-wide">
            <i class="fa-solid fa-utensils mr-1"></i>已扣除午休
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-center mb-2">
          <div class="bg-black/20 rounded-lg p-2 backdrop-blur-sm border border-white/10">
            <div class="text-[10px] opacity-70 mb-1 font-bold">START</div>
            <div class="font-bold font-mono text-xl" id="formStart">--:--</div>
          </div>
          <div class="flex items-center justify-center text-white/50">
            <i class="fa-solid fa-plane text-xs"></i>
          </div>
          <div class="bg-black/20 rounded-lg p-2 backdrop-blur-sm border border-white/10">
            <div class="text-[10px] opacity-70 mb-1 font-bold">END</div>
            <div class="font-bold font-mono text-xl" id="formEnd">--:--</div>
          </div>
        </div>

        <div class="text-center mb-4">
          <span class="text-[10px] opacity-70 mr-2">TOTAL DURATION</span>
          <span class="font-bold text-yellow-300 text-lg" id="formHours">0 小時</span>
        </div>
      </div>

      <!-- 下半部 -->
      <div class="bg-white/95 text-slate-800 p-4 text-center relative z-10">
        <div class="absolute -top-3 left-0 w-4 h-6 bg-slate-100 rounded-r-full"></div>
        <div class="absolute -top-3 right-0 w-4 h-6 bg-slate-100 rounded-l-full"></div>

        <h2 class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-wide" id="resultTitle">建議打卡時間</h2>
        <div class="text-5xl font-bold tracking-tighter text-slate-800" id="bigResultTime">--:--</div>
        <div class="text-[10px] text-slate-400 mt-1 font-medium bg-slate-100 inline-block px-2 py-1 rounded-full">
          (打卡依彈性，假單依單位對齊)
        </div>
      </div>

      <!-- 背景裝飾 -->
      <div class="absolute top-4 -right-8 opacity-10 pointer-events-none transform rotate-[-45deg]">
        <i class="fa-solid fa-plane-up text-9xl"></i>
      </div>
    </section>

  </main>

  <script>
    // === 狀態 ===
    let currentMode = 'morning';
    let leaveHours = 1.5;
    let step = 0.5;

    // === 時間常數 ===
    const LUNCH_START = 12 * 60 + 30; // 12:30
    const LUNCH_END   = 13 * 60;      // 13:00
    const FLEX_START  = 8 * 60;       // 08:00
    const STD_START   = 8 * 60 + 30;  // 08:30

    // === DOM ===
    const els = {
      header: document.getElementById('mainHeader'),
      card: document.getElementById('resultCard'),
      arrival: document.getElementById('arrivalTime'),
      sectionTimeInput: document.getElementById('sectionTimeInput'),
      earlyWarning: document.getElementById('earlyWarning'),
      btnMorning: document.getElementById('btnMorning'),
      btnLeave: document.getElementById('btnLeave'),
      leaveType: document.getElementById('leaveType'),
      displayHours: document.getElementById('displayHours'),
      btnMinus: document.getElementById('btnMinus'),
      btnPlus: document.getElementById('btnPlus'),
      bigResultTime: document.getElementById('bigResultTime'),
      formStart: document.getElementById('formStart'),
      formEnd: document.getElementById('formEnd'),
      formHours: document.getElementById('formHours'),
      resultTitle: document.getElementById('resultTitle'),
      statusTag: document.getElementById('statusTag'),
    };

    function init() {
      els.arrival.addEventListener('input', calculate);
      updateStep();         // 讓 step 跟 select 同步
      setMode('morning');
    }

    function setMode(mode) {
      currentMode = mode;
      const isMorning = mode === 'morning';
      const activeColor = isMorning ? 'morning' : 'brand';

      // 主色切換
      updateThemeColor(els.header, activeColor);
      updateThemeColor(els.card, activeColor);

      // 兩顆模式按鈕
      updateBtnState(els.btnMorning, isMorning, 'morning');
      updateBtnState(els.btnLeave, !isMorning, 'brand');

      // input / select focus 顏色
      updateFocusBorderTheme(els.arrival, activeColor);
      updateFocusBorderTheme(els.leaveType, activeColor);

      // +/- 字色
      updateText600Theme(els.btnMinus, activeColor);
      updateText600Theme(els.btnPlus, activeColor);

      // 區塊顯示
      if (isMorning) {
        els.sectionTimeInput.classList.add('hidden');
        els.resultTitle.textContent = "應到班打卡時間";
      } else {
        els.sectionTimeInput.classList.remove('hidden');
        els.resultTitle.textContent = "建議打卡下班時間";
      }

      calculate();
    }

    // === Theme helpers ===
    function updateThemeColor(el, color) {
      el.className = el.className.replace(/bg-\w+-600/g, `bg-${color}-600`);
    }

    function updateBtnState(btn, isActive, color) {
      if (isActive) {
        btn.className =
          `btn-press py-4 rounded-lg flex flex-col items-center justify-center border-2 relative overflow-hidden theme-transition group ` +
          `bg-${color}-50 text-${color}-600 border-${color}-200 shadow-inner`;
      } else {
        btn.className =
          `btn-press py-4 rounded-lg flex flex-col items-center justify-center border-2 border-transparent relative overflow-hidden theme-transition group ` +
          `text-slate-400 bg-white shadow-sm`;
      }
    }

    function updateFocusBorderTheme(el, color) {
      // 確保有 focus:border-*-500
      if (!/focus:border-\w+-500/.test(el.className)) {
        el.className += ` focus:border-${color}-500`;
      } else {
        el.className = el.className.replace(/focus:border-\w+-500/g, `focus:border-${color}-500`);
      }
    }

    function updateText600Theme(el, color) {
      if (!/text-\w+-600/.test(el.className)) {
        el.className += ` text-${color}-600`;
      } else {
        el.className = el.className.replace(/text-\w+-600/g, `text-${color}-600`);
      }
    }

    // === Hours control ===
    function updateStep() {
      step = parseFloat(els.leaveType.value);
      if (leaveHours > 0) {
        leaveHours = Math.round(leaveHours / step) * step;
      }
      els.displayHours.innerText = leaveHours.toFixed(1);
      calculate();
    }

    function changeHours(dir) {
      leaveHours += dir * step;
      if (leaveHours < 0) leaveHours = 0;
      leaveHours = Math.round(leaveHours * 10) / 10;
      els.displayHours.innerText = leaveHours.toFixed(1);
      calculate();
    }

    // === Time helpers ===
    function parseTime(t) {
      if (!t || !/^\d{2}:\d{2}$/.test(t)) return null;
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function formatTime(min) {
      let h = Math.floor(min / 60);
      let m = min % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function isLunch(min) {
      return min >= LUNCH_START && min < LUNCH_END;
    }

    // 往後加「工作分鐘」（午休不算工作分鐘）
    function addWorkMinutes(startMin, workMinutes) {
      let current = startMin;
      let remaining = Math.round(workMinutes);

      while (remaining > 0) {
        if (isLunch(current)) {
          current++;
        } else {
          current++;
          remaining--;
        }
      }
      return current;
    }

    // 往前減「工作分鐘」（午休不算工作分鐘）
    function subWorkMinutes(endMin, workMinutes) {
      let current = endMin;
      let remaining = Math.round(workMinutes);

      while (remaining > 0) {
        current--;
        if (isLunch(current)) continue;
        remaining--;
      }
      return current;
    }

    // 依 step 對齊：0.5 小時 -> 30 分；1 小時 -> 60 分
    function floorToStep(min, stepHours) {
      const stepMin = Math.round(stepHours * 60);
      return Math.floor(min / stepMin) * stepMin;
    }

    // === Main calc ===
    function calculate() {
      const arrivalMin = parseTime(els.arrival.value);
      els.statusTag.classList.add('hidden');
      els.earlyWarning.classList.add('hidden');

      // ---------- 下午請假 ----------
      if (currentMode === 'leave') {
        if (arrivalMin == null) {
          els.bigResultTime.innerText = "--:--";
          els.formStart.innerText = "--:--";
          els.formEnd.innerText = "--:--";
          els.formHours.innerText = leaveHours + " 小時";
          return;
        }

        // 基準下班：刷卡時間 + 8.5 小時；但早於 08:00 以 08:00 計
        let baseEndMin;
        if (arrivalMin < FLEX_START) {
          baseEndMin = 16 * 60 + 30; // 08:00 + 8.5h
          els.earlyWarning.classList.remove('hidden');
        } else {
          baseEndMin = arrivalMin + 510; // 8.5h
        }

        // 建議打卡（實際打卡）= 基準下班 - 請假工作分鐘（午休不算）
        const minutesToDeduct = leaveHours * 60;
        const clockOutMin = subWorkMinutes(baseEndMin, minutesToDeduct);

        // 假單時間：起點先依 step 對齊（0.5 對齊半點；1 對齊整點）
        const formStartMin = (leaveHours === 0) ? null : floorToStep(clockOutMin, step);
        const formEndMin   = (leaveHours === 0) ? null : addWorkMinutes(formStartMin, leaveHours * 60);

        els.bigResultTime.innerText = formatTime(clockOutMin);
        els.formStart.innerText = (leaveHours === 0) ? "--:--" : formatTime(formStartMin);
        els.formEnd.innerText   = (leaveHours === 0) ? "--:--" : formatTime(formEndMin);
        els.formHours.innerText = leaveHours + " 小時";

        // 假單跨午休就顯示「已扣除午休」
        if (leaveHours > 0 && formStartMin < LUNCH_START && formEndMin > LUNCH_END) {
          els.statusTag.classList.remove('hidden');
        }
      }

      // ---------- 上午請假 ----------
      else {
        if (leaveHours === 0) {
          els.bigResultTime.innerText = formatTime(STD_START);
          els.formStart.innerText = "--:--";
          els.formEnd.innerText = "--:--";
          els.formHours.innerText = "0 小時";
          return;
        }

        const startMin = STD_START; // 08:30
        const arriveMin = addWorkMinutes(startMin, leaveHours * 60);

        // 假單起點依 step 對齊：0.5 半點/ 1 整點
        const formStartMin = floorToStep(startMin, step);
        const formEndMin = arriveMin;

        els.bigResultTime.innerText = formatTime(arriveMin);
        els.formStart.innerText = formatTime(formStartMin);
        els.formEnd.innerText   = formatTime(formEndMin);
        els.formHours.innerText = leaveHours + " 小時";

        if (leaveHours > 0 && formStartMin < LUNCH_START && formEndMin > LUNCH_END) {
          els.statusTag.classList.remove('hidden');
        }
      }
    }

    init();
  </script>
</body>
</html>
